# Плагин поиска множественных материалов для ЛОЦМАН Клиент

## Назначение
Плагин предназначен для автоматического поиска деталей и заготовок в выбранной папке, у которых имеется более одного связанного материала (или один и тот же материал привязан несколько раз). Это позволяет выявить потенциальные ошибки в структуре изделия и дублирующиеся спецификации.

## Основные возможности
- **Анализ выбранной папки** – обход всех объектов, включая прямые и обратные связи.
- **Выделение деталей и заготовок** – объекты типов «Деталь» и «Заготовка».
- **Проверка материалов**:
  - Для деталей – материалы типа «Материал по КД».
  - Для заготовок – материалы типа «Материал основной».
- **Поиск заготовок через обратную связь** – если заготовка не входит напрямую в папку, но связана с деталью через связь «Заготовка для», она будет добавлена в анализ.
- **Открытие найденных объектов в новых окнах ЛОЦМАН** – после завершения анализа все объекты с множественными материалами открываются в отдельных окнах для быстрого просмотра и редактирования.
- **Информативное сообщение** – краткая статистика: количество найденных проблемных объектов и общее число связей с материалами.
- **Логирование** – отладочная информация сохраняется в файл `%TEMP%\DeepDuplicateFinder.log`.

## Принцип работы
1. Пользователь выделяет папку в дереве объектов ЛОЦМАН.
2. В контекстном меню выбирает пункт **«Найти множественные материалы (детали+заготовки)»**.
3. Плагин выполняет следующие действия:
   - Получает идентификатор выбранной папки.
   - Рекурсивно обходит все связанные объекты (прямые и обратные связи).
   - Загружает словарь типов объектов из системы.
   - Определяет среди собранных объектов детали (`Деталь`) и заготовки (`Заготовка`).
   - Для каждой детали находит связанные материалы типа `Материал по КД`.
   - Для каждой заготовки находит связанные материалы типа `Материал основной`.
   - Если у объекта количество уникальных материалов превышает 1 (или один материал повторяется), объект добавляется в список результатов.
   - Дополнительно ищет заготовки, связанные с деталями через обратную связь `Заготовка для`.
4. После завершения анализа:
   - Открываются новые окна ЛОЦМАН для всех найденных объектов (список идентификаторов передаётся через оконное сообщение `WM_OPENOBJECTSINNEWWINDOW`).
   - Пользователю показывается сообщение с количеством проблемных объектов и общим числом связей.

## Требования
- ЛОЦМАН Клиент версии **2014 или новее** (поддержка оконного сообщения `WM_OPENOBJECTSINNEWWINDOW`).
- .NET Framework **4.7.2** или выше.
- Ссылка на сборку **Ascon.Plm.Loodsman.PluginSDK.dll** (обычно находится в папке установки ЛОЦМАН Клиент).

## Установка
1. Скомпилируйте проект, получив файл `DeepDuplicateFinder.dll`.
2. Создайте папку для плагина, например:  
   `%ProgramData%\ASCON\LOODSMAN\PluginStore\DeepDuplicateFinder`
3. Поместите `DeepDuplicateFinder.dll` в созданную папку.
4. В ЛОЦМАН Клиент откройте **Настройки → Подключаемые модули** и добавьте путь к этой папке.
5. Перезапустите ЛОЦМАН Клиент (если требуется).

## Использование
1. В дереве объектов выделите папку, которую хотите проанализировать.
2. Нажмите правую кнопку мыши и выберите пункт меню **«Найти множественные материалы (детали+заготовки)»**.
3. Дождитесь завершения анализа. После этого:
   - Откроются новые окна ЛОЦМАН с найденными объектами.
   - Появится сообщение со статистикой.
4. При необходимости можно просмотреть лог-файл `%TEMP%\DeepDuplicateFinder.log` для детальной отладочной информации.

## Структура проекта
```
DeepDuplicateFinder/
├── DeepDuplicateFinder.cs      # Основной класс плагина и вспомогательные классы (ObjectInfo, MaterialGroup и др.)
└── WindowOpener.cs             # Класс для открытия окон ЛОЦМАН через оконное сообщение
```
Примечание: в текущей реализации оба класса находятся в одном файле `DeepDuplicateFinder.cs`.

## Настройка типов объектов
В коде используются константы, определяющие имена типов и связей:
```csharp
private const string MATERIAL_TYPE_NAME = "Материал по КД";
private const string DETAIL_TYPE_NAME = "Деталь";
private const string MATERIAL_MAIN_TYPE_NAME = "Материал основной";
private const string PREPARATION_TYPE_NAME = "Заготовка";
private const string PREPARATION_LINK_NAME = "Заготовка для";
```
Если в вашей конфигурации ЛОЦМАН эти имена отличаются, их необходимо скорректировать перед компиляцией.

## Логирование
Плагин записывает отладочную информацию в файл:
```
%TEMP%\DeepDuplicateFinder.log
```
Это помогает при диагностике, если анализ работает не так, как ожидается.

## Примечания
- Плагин не изменяет данные в базе, только читает их.
- Открытие окон происходит через асинхронное сообщение; если окна не открываются, убедитесь, что главное окно ЛОЦМАН активно и не заблокировано модальным диалогом.
- При возникновении ошибок плагин выводит сообщение с описанием и записывает исключение в лог.

## Версия
Текущая версия: **2.0**  
Основные изменения по сравнению с предыдущей версией:
- Убран HTML-отчёт; вместо него используется открытие окон ЛОЦМАН.
- Добавлен поиск заготовок через обратную связь.
- Упрощён финальный вывод.
- Добавлено подробное логирование.

## Автор
Разработано для внутренних нужд. По вопросам и предложениям обращайтесь к разработчику.
